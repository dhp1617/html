<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Large Red Box AR Marker</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-gps-entity-place.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }
        #ar-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 10000;
            max-width: 300px;
        }
        #permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            text-align: center;
        }
        #permission-overlay button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Permission Overlay -->
    <div id="permission-overlay">
        <h2>AR Experience Requires Permissions</h2>
        <p>Please enable:</p>
        <ul style="text-align: left; display: inline-block;">
            <li>Camera access</li>
            <li>Location services</li>
        </ul>
        <button id="enable-ar">Enable AR</button>
        <div id="permission-status"></div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        style="display: none;"
    >
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- GIANT RED BOX at your coordinates -->
        <a-entity
            gps-entity-place="latitude: 10.939230; longitude: 76.743130"
            scale="1 1 1"
        >
            <!-- Main red box (50m x 50m x 50m) -->
            <a-box 
                color="red" 
                scale="50 50 50" 
                position="0 25 0"
                material="transparent: false; opacity: 0.9;"
                shadow="cast: true; receive: false"
            ></a-box>
            
            <!-- Pulsing animation for visibility -->
            <a-animation 
                attribute="scale"
                dur="2000"
                from="45 45 45"
                to="50 50 50"
                repeat="indefinite"
                direction="alternate"
            ></a-animation>
            
            <!-- Floating label -->
            <a-text 
                value="TARGET LOCATION" 
                color="white" 
                position="0 60 0" 
                scale="25 25 25"
                align="center"
                shadow="color: black; opacity: 0.8"
            ></a-text>
        </a-entity>
    </a-scene>

    <!-- Status Panel -->
    <div id="ar-status" style="display: none;">
        <h3 style="margin-top: 0;">AR Navigation Active</h3>
        <div>Target: 10.939230, 76.743130</div>
        <div>Your position: <span id="user-position">Acquiring...</span></div>
        <div>Distance: <span id="distance">--</span> meters</div>
    </div>

    <script>
        // Configuration
        const TARGET_LOCATION = {
            lat: 10.939230,
            lon: 76.743130
        };

        // DOM Elements
        const overlay = document.getElementById('permission-overlay');
        const enableBtn = document.getElementById('enable-ar');
        const statusDiv = document.getElementById('permission-status');
        const arScene = document.querySelector('a-scene');
        const arStatus = document.getElementById('ar-status');
        let watchId = null;

        // Check permissions
        async function enableAR() {
            statusDiv.innerHTML = "Checking permissions...";
            
            try {
                // 1. Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                stream.getTracks().forEach(track => track.stop());
                
                // 2. Request location access
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });
                
                startARExperience();
            } catch (error) {
                statusDiv.innerHTML = `Error: ${error.message}<br>Please refresh and try again.`;
                console.error("Permission error:", error);
            }
        }

        // Start AR experience
        function startARExperience() {
            overlay.style.display = 'none';
            arScene.style.display = 'block';
            arStatus.style.display = 'block';
            
            // Start watching position
            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000,
                    timeout: 5000
                }
            );
            
            // When AR is ready
            arScene.addEventListener('arjs-video-loaded', () => {
                arStatus.innerHTML += "<br>AR camera activated!";
            });
        }

        // Update position display
        function updatePosition(position) {
            const lat = position.coords.latitude;
            const lon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            document.getElementById('user-position').textContent = 
                `${lat.toFixed(6)}, ${lon.toFixed(6)} (±${accuracy.toFixed(1)}m)`;
            
            // Calculate distance to target
            const distance = calculateDistance(
                lat, lon,
                TARGET_LOCATION.lat, TARGET_LOCATION.lon
            );
            
            document.getElementById('distance').textContent = Math.round(distance);
        }

        // Handle position errors
        function handlePositionError(error) {
            console.error("GPS error:", error);
            document.getElementById('user-position').textContent = "GPS Error";
        }

        // Haversine distance calculation
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Clean up on exit
        window.addEventListener('beforeunload', () => {
            if (watchId) navigator.geolocation.clearWatch(watchId);
        });

        // Initialize
        enableBtn.addEventListener('click', enableAR);
    </script>
</body>
</html>
