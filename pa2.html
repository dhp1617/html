<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Multiple AR Markers (100m Visibility)</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-gps-entity-place.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: Arial;
        }
        #ar-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 15px;
            border-radius: 5px;
            z-index: 10000;
            max-width: 300px;
        }
        #permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10001;
            text-align: center;
        }
        #permission-overlay button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Permission Overlay -->
    <div id="permission-overlay">
        <h2>AR Experience Requires Permissions</h2>
        <p>Please enable:</p>
        <ul style="text-align: left; display: inline-block;">
            <li>Camera access</li>
            <li>Location services</li>
        </ul>
        <button id="enable-ar">Enable AR</button>
        <div id="permission-status"></div>
    </div>

    <!-- AR Scene -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        style="display: none;"
    >
        <a-camera gps-camera rotation-reader></a-camera>
        
        <!-- ===== ALL LOCATION MARKERS ===== -->
        <!-- These will be controlled by JavaScript -->
        <a-entity id="marker-container"></a-entity>
    </a-scene>

    <!-- Status Panel -->
    <div id="ar-status" style="display: none;">
        <h3 style="margin-top: 0;">AR Navigation Active</h3>
        <div>Visible markers: <span id="visible-count">0</span>/8</div>
        <div>Your position: <span id="user-position">Acquiring...</span></div>
        <div>Nearest marker: <span id="nearest-distance">--</span> meters</div>
    </div>

    <script>
        // All target locations
        const TARGET_LOCATIONS = [
            { lat: 10.939230, lon: 76.743130, name: "Location 1" },
            { lat: 10.938572, lon: 76.743037, name: "Location 2" },
            { lat: 10.938601, lon: 76.743306, name: "Location 3" },
            { lat: 10.938319, lon: 76.744216, name: "Location 4" },
            { lat: 10.937588, lon: 76.744049, name: "Location 5" },
            { lat: 10.937849, lon: 76.744127, name: "Location 6" },
            { lat: 10.939929, lon: 76.742443, name: "Location 7" },
            { lat: 10.938619, lon: 76.743767, name: "Location 8" }
        ];

        // DOM Elements
        const overlay = document.getElementById('permission-overlay');
        const enableBtn = document.getElementById('enable-ar');
        const statusDiv = document.getElementById('permission-status');
        const arScene = document.querySelector('a-scene');
        const arStatus = document.getElementById('ar-status');
        const markerContainer = document.getElementById('marker-container');
        let watchId = null;

        // Create all markers
        function createMarkers() {
            TARGET_LOCATIONS.forEach((location, index) => {
                const marker = document.createElement('a-entity');
                marker.setAttribute('gps-entity-place', {
                    latitude: location.lat,
                    longitude: location.lon
                });
                marker.setAttribute('visible', 'false');
                marker.setAttribute('id', `marker-${index}`);
                
                // Add the red box
                const box = document.createElement('a-box');
                box.setAttribute('color', 'red');
                box.setAttribute('scale', '10 10 10');
                box.setAttribute('position', '0 5 0');
                marker.appendChild(box);
                
                // Add the label
                const text = document.createElement('a-text');
                text.setAttribute('value', location.name);
                text.setAttribute('position', '0 10 0');
                text.setAttribute('scale', '5 5 5');
                text.setAttribute('align', 'center');
                text.setAttribute('color', 'white');
                marker.appendChild(text);
                
                markerContainer.appendChild(marker);
            });
        }

        // Check permissions
        async function enableAR() {
            statusDiv.innerHTML = "Checking permissions...";
            
            try {
                // 1. Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                stream.getTracks().forEach(track => track.stop());
                
                // 2. Request location access
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 10000
                    });
                });
                
                startARExperience();
            } catch (error) {
                statusDiv.innerHTML = `Error: ${error.message}<br>Please refresh and try again.`;
                console.error("Permission error:", error);
            }
        }

        // Start AR experience
        function startARExperience() {
            overlay.style.display = 'none';
            arScene.style.display = 'block';
            arStatus.style.display = 'block';
            
            // Create all markers
            createMarkers();
            
            // Start watching position
            watchId = navigator.geolocation.watchPosition(
                updatePosition,
                handlePositionError,
                {
                    enableHighAccuracy: true,
                    maximumAge: 3000,
                    timeout: 5000
                }
            );
            
            // When AR is ready
            arScene.addEventListener('arjs-video-loaded', () => {
                arStatus.innerHTML += "<br>AR camera activated!";
            });
        }

        // Update position display and marker visibility
        function updatePosition(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            document.getElementById('user-position').textContent = 
                `${userLat.toFixed(6)}, ${userLon.toFixed(6)} (±${accuracy.toFixed(1)}m)`;
            
            // Calculate distances to all targets
            let nearestDistance = Infinity;
            let visibleCount = 0;
            
            TARGET_LOCATIONS.forEach((loc, index) => {
                const distance = calculateDistance(
                    userLat, userLon,
                    loc.lat, loc.lon
                );
                
                // Update nearest marker
                if (distance < nearestDistance) {
                    nearestDistance = distance;
                }
                
                // Control visibility (within 100m)
                const marker = document.getElementById(`marker-${index}`);
                if (marker) {
                    if (distance < 100) { // 100 meter visibility range
                        marker.setAttribute('visible', 'true');
                        visibleCount++;
                    } else {
                        marker.setAttribute('visible', 'false');
                    }
                }
            });
            
            document.getElementById('nearest-distance').textContent = Math.round(nearestDistance);
            document.getElementById('visible-count').textContent = visibleCount;
        }

        // Handle position errors
        function handlePositionError(error) {
            console.error("GPS error:", error);
            document.getElementById('user-position').textContent = "GPS Error";
        }

        // Haversine distance calculation
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth radius in meters
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                      Math.cos(φ1) * Math.cos(φ2) *
                      Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // Clean up on exit
        window.addEventListener('beforeunload', () => {
            if (watchId) navigator.geolocation.clearWatch(watchId);
        });

        // Initialize
        enableBtn.addEventListener('click', enableAR);
    </script>
</body>
</html>
