<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>AR Tour Guide with Permission Handling</title>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <style>
        body { 
            margin: 0; 
            overflow: hidden;
            font-family: Arial;
        }
        #permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            text-align: center;
            padding: 20px;
        }
        #permission-overlay button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 18px;
            margin: 10px;
            border-radius: 5px;
            cursor: pointer;
        }
        #ar-status {
            position: fixed;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 9999;
        }
    </style>
</head>
<body>
    <!-- Permission Request Overlay -->
    <div id="permission-overlay">
        <h2>AR Experience Requires Permissions</h2>
        <p>Please enable camera and location access to continue</p>
        <button id="request-permissions">Grant Permissions</button>
        <div id="permission-status" style="margin-top: 20px;"></div>
    </div>

    <!-- AR Scene (initially hidden) -->
    <a-scene 
        vr-mode-ui="enabled: false"
        embedded
        arjs="sourceType: webcam; debugUIEnabled: false;"
        style="display: none;"
    >
        <a-camera gps-camera rotation-reader></a-camera>
        <!-- Your AR content here -->
        <a-entity gps-entity-place="latitude: 10.939230; longitude: 76.743130">
            <a-box color="red" scale="50 50 50" position="0 25 0"></a-box>
            <a-text value="Landmark" color="white" position="0 60 0" scale="25 25 25"></a-text>
        </a-entity>
    </a-scene>

    <!-- Status Display -->
    <div id="ar-status" style="display: none;">Initializing AR...</div>

    <script>
        // DOM Elements
        const permissionOverlay = document.getElementById('permission-overlay');
        const requestBtn = document.getElementById('request-permissions');
        const permissionStatus = document.getElementById('permission-status');
        const arScene = document.querySelector('a-scene');
        const arStatus = document.getElementById('ar-status');

        // Check permissions on load
        document.addEventListener('DOMContentLoaded', checkPermissions);

        // Button to request permissions
        requestBtn.addEventListener('click', async () => {
            permissionStatus.innerHTML = "Checking permissions...";
            await requestPermissions();
        });

        // Permission check function
        async function checkPermissions() {
            try {
                // Check camera permissions
                const cameraPerm = await navigator.permissions.query({ name: 'camera' });
                const locationPerm = await navigator.permissions.query({ name: 'geolocation' });
                
                if (cameraPerm.state === 'granted' && locationPerm.state === 'granted') {
                    startARExperience();
                } else {
                    permissionStatus.innerHTML = "Permissions not yet granted";
                }
            } catch (e) {
                // Fallback for browsers that don't support permissions API
                permissionStatus.innerHTML = "Please grant permissions when prompted";
            }
        }

        // Permission request function
        async function requestPermissions() {
            try {
                // Request camera access
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: {
                        facingMode: { ideal: 'environment' } // Prefer rear camera
                    } 
                });
                
                // Stop the stream immediately (we just needed permission)
                stream.getTracks().forEach(track => track.stop());
                
                // Request location access
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(resolve, reject, {
                        enableHighAccuracy: true,
                        timeout: 5000
                    });
                });
                
                startARExperience();
            } catch (error) {
                permissionStatus.innerHTML = `Error: ${error.message}`;
                if (error.name === 'NotAllowedError') {
                    permissionStatus.innerHTML += "<br>Please enable permissions in your browser settings";
                }
                console.error("Permission error:", error);
            }
        }

        // Start AR once permissions are granted
        function startARExperience() {
            permissionOverlay.style.display = 'none';
            arScene.style.display = 'block';
            arStatus.style.display = 'block';
            
            // Add event listeners for AR scene
            arScene.addEventListener('arjs-video-loaded', () => {
                arStatus.innerHTML = "AR camera ready!";
            });
            
            arScene.addEventListener('arjs-gps-camera-update-position', (e) => {
                const pos = e.detail.position;
                arStatus.innerHTML = `
                    GPS Position: ${pos.latitude.toFixed(6)}, ${pos.longitude.toFixed(6)}<br>
                    Accuracy: Â±${pos.accuracy.toFixed(1)} meters
                `;
            });
        }

        // Fallback for browsers without permissions API
        if (!navigator.permissions) {
            permissionStatus.innerHTML = "This browser doesn't support permission checks.<br>Please grant permissions when prompted.";
        }
    </script>
</body>
</html>
